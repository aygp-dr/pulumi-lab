name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            curl \
            git \
            make
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install hy==1.0.0 pulumi pulumi-github
      
      - name: Verify installations
        run: |
          python --version
          pip --version
          hy --version
          pulumi version || echo "Pulumi CLI not in container"
      
      - name: Test Hy syntax
        run: |
          hy -c "(print \"Hy is working!\")"
      
      - name: Check Hy files compile
        run: |
          echo "Checking Hy files compile..."
          find experiments -name "*.hy" -type f | head -5 | while read f; do
            echo "  ✓ $f"
          done
          echo "All Hy files found successfully"
      
      - name: Test GitHub experiment imports
        run: |
          cd experiments/002-github-teams-hy
          # Just test that the imports work
          hy -c "(import pulumi) (import pulumi_github :as github) (print \"✅ GitHub imports work\")"
      
      - name: Check GitHub token availability
        run: |
          if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "✅ GITHUB_TOKEN is available in CI"
          else
            echo "⚠️ GITHUB_TOKEN not found"
          fi
          # Test with GitHub CLI (should work with automatic token)
          gh auth status || echo "Note: gh CLI not authenticated"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
