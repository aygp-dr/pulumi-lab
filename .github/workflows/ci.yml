name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            curl \
            git \
            make
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install hy==1.0.0 pulumi pulumi-github
      
      - name: Verify installations
        run: |
          python --version
          pip --version
          hy --version
          pulumi version || echo "Pulumi CLI not in container"
      
      - name: Test Hy syntax
        run: |
          hy -c "(print \"Hy is working!\")"
      
      - name: Check Hy files syntax
        run: |
          find experiments -name "*.hy" -type f | head -5 | while read f; do
            echo "Checking: $f"
            hy -c "(import hy.reader) (hy.reader.read (open \"$f\").read())" || exit 1
          done
      
      - name: Test GitHub experiment imports
        run: |
          cd experiments/002-github-teams-hy
          # Just test that the imports work
          hy -c "(import pulumi) (import pulumi_github :as github) (print \"âœ… GitHub imports work\")"
